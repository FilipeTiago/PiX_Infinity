#!/bin/bash
set -euo pipefail

ES_MATCH='[e]mulationstation'   # safe pattern to avoid matching grep/pgrep itself

stop() {
  pkill -TERM -f "$ES_MATCH" 2>/dev/null || true
  # wait up to 3s for ES to exit
  for _ in {1..30}; do
    pgrep -f "$ES_MATCH" >/dev/null || break
    sleep 0.1
  done
  # last resort
  pgrep -f "$ES_MATCH" >/dev/null && pkill -KILL -f "$ES_MATCH" || true
  sleep 0.2
}

start() {
  pgrep -f "$ES_MATCH" >/dev/null || (emulationstation >/dev/null 2>&1 &)
}

status() {
  if pgrep -f "$ES_MATCH" >/dev/null; then
    echo "running"
  else
    echo "stopped"
  fi
}

case "${1:-}" in
  stop) stop ;;
  start) start ;;
  restart) stop; start ;;
  status) status ;;
  *) echo "usage: esctl {stop|start|restart|status}"; exit 2 ;;
esac



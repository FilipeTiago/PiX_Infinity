#!/usr/bin/env bash
# Build gamelist.xml for the Radio system from .m3u files and downloaded logos.
set -euo pipefail
command -v pix_rom_location >/dev/null 2>&1 || { echo "[radio-gamelist] need pix_rom_location" >&2; exit 2; }

ROM_ROOT="$(pix_rom_location radio || true)"
[ -n "$ROM_ROOT" ] || { echo "[radio-gamelist] radio ROM root not found"; exit 1; }
[ -d "$ROM_ROOT" ] || { echo "[radio-gamelist] not a directory: $ROM_ROOT"; exit 1; }

GAMELIST="$ROM_ROOT/gamelist.xml"
LOGOS="$HOME/.emulationstation/downloaded_images/radio/logos"

xml_escape(){ sed -e 's/&/\&amp;/g' -e 's/</\&lt;/g' -e 's/>/\&gt;/g' -e 's/\"/\&quot;/g' -e "s/'/\&apos;/g"; }

tmp="$(mktemp)"; trap 'rm -f "$tmp"' EXIT
echo '[radio-gamelist] ROM root:' "$ROM_ROOT"

{
  echo '<?xml version="1.0"?>'
  echo '<gameList>'
} > "$tmp"

count=0
while IFS= read -r -d '' f; do
  rel="${f#$ROM_ROOT/}"
  base="$(basename "$f")"
  name="${base%.m3u}"
  # build display name from file (replace underscores with spaces)
  disp="$(printf '%s' "$name" | sed 's/_/ /g; s/  \+/ /g')"

  cc="$(basename "$(dirname "$(dirname "$rel")")")"
  genre="$(basename "$(dirname "$rel")")"

  # find a matching logo
  image=""
  for ext in png jpg jpeg webp gif ico; do
    cand="$LOGOS/$cc/$genre/$name.$ext"
    [ -f "$cand" ] && { image="$cand"; break; }
  done

  {
    echo '  <game>'
    echo "    <path>./$(printf '%s' "$rel" | xml_escape)</path>"
    echo "    <name>$(printf '%s' "$disp" | xml_escape)</name>"
    [ -n "$image" ] && echo "    <image>$(printf '%s' "$image" | xml_escape)</image>"
    echo "    <desc>Country: $cc Â· Genre: $genre</desc>"
    echo '  </game>'
  } >> "$tmp"

  count=$((count+1))
done < <(find "$ROM_ROOT" -type f -name '*.m3u' -print0 | sort -z)

echo '</gameList>' >> "$tmp"
mv "$tmp" "$GAMELIST"
chmod 644 "$GAMELIST"
echo "[radio-gamelist] wrote $GAMELIST  (items: $count)"

#!/usr/bin/env bash
set -euo pipefail

LOG="/tmp/pix-moon-${USER}.log"
CFG="${1:-}"
: > "$LOG"

# tidy helpers
trim() { local s="${1:-}"; s="${s#"${s%%[![:space:]]*}"}"; echo "${s%"${s##*[![:space:]]}"}"; }

{
  echo "===== $(date) ====="
  echo "cfg=$CFG"
  echo "user=$(whoami) uid=$(id -u)"
  echo "tty=$(tty) fgconsole=$(fgconsole 2>/dev/null || true)"

  # ---- parse .moon ----
  host=""; app=""; res="1080"; fps="60"; codec="h264"; bitrate="20000"; audiocard=""
  while IFS='=' read -r k v; do
    k="$(trim "${k:-}")"; v="$(trim "${v:-}")"
    [[ -z "$k" || "${k:0:1}" = "#" ]] && continue
    case "$k" in
      host) host="$v" ;;
      app) app="$v" ;;
      res) res="$v" ;;
      fps) fps="$v" ;;
      codec) codec="$v" ;;
      bitrate) bitrate="$v" ;;
      audiocard) audiocard="$v" ;;  # optional override: vc4hdmi0 / vc4hdmi1
    esac
  done < "$CFG"

  # ---- environment (video) ----
  export XDG_RUNTIME_DIR="${XDG_RUNTIME_DIR:-/run/user/$(id -u)}"
  export SDL_VIDEODRIVER="${SDL_VIDEODRIVER:-kmsdrm}"
  unset DISPLAY WAYLAND_DISPLAY XDG_SESSION_TYPE

  # ---- environment (audio): prefer Pulse, fallback ALSA 'default', last-resort sysdefault ----
  unset AUDIODEV
  if [[ -S "$XDG_RUNTIME_DIR/pulse/native" ]]; then
    export SDL_AUDIODRIVER=pulse
    export PULSE_SERVER="unix:$XDG_RUNTIME_DIR/pulse/native"
    echo "[audio] SDL_AUDIODRIVER=pulse PULSE_SERVER=$PULSE_SERVER"
  else
    export SDL_AUDIODRIVER=alsa
    if [[ -n "$audiocard" ]]; then
      AUDIODEV="sysdefault:CARD=${audiocard}"
    else
      AUDIODEV="default"   # routes to PipeWire mixer if available
    fi
    export AUDIODEV
    echo "[audio] SDL_AUDIODRIVER=alsa AUDIODEV=$AUDIODEV"
  fi

  # ---- build args (ensure EXACTLY ONE resolution flag) ----
  args=(stream -app "$app")
  case "$res" in
    720|0720) args+=(-720) ;;
    1080|1080p) args+=(-1080) ;;
    4k|2160|2160p|3840x2160) args+=(-4k) ;;
    *x*)  # WIDTHxHEIGHT
      width="${res%x*}"; height="${res#*x}"
      args+=(-width "$width" -height "$height")
      ;;
    *)    # unknown -> default 1080
      args+=(-1080)
      ;;
  esac
  args+=(-fps "$fps" -codec "$codec" -bitrate "$bitrate" "$host")

  echo "Launching: /usr/local/bin/moonlight ${args[*]}"
  # avoid zombie previous runs
  pkill -f '^/usr/local/bin/moonlight stream' || true

  /usr/local/bin/moonlight "${args[@]}"
  rc=$?
  echo "Moonlight rc=$rc"
  exit $rc
} | tee -a "$LOG"

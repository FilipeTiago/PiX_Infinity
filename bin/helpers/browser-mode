#!/usr/bin/env bash
set -euo pipefail

# Try relative (repo/dev install), then fall back to canonical install path.
# shellcheck source=/dev/null
if ! source "$(dirname "${BASH_SOURCE[0]}")/system/paths" 2>/dev/null; then
  source "/opt/pix-infinity/bin/system/paths"
fi

USER_NAME="infinity"
VT_BROWSER="vt7"           # use a VT not used by ES/games
DISPLAY_NUM=":0"

# If X isn't up yet on :0/vt7, start it
if ! [ -S /tmp/.X11-unix/X0 ]; then
  chvt 7 || true
  sudo -u "$USER_NAME" startx /home/"$USER_NAME"/.xinitrc-browser -- "$DISPLAY_NUM" "$VT_BROWSER" -nolisten tcp -s 0 -dpms &
  # wait for X socket
  for i in $(seq 1 50); do
    [ -S /tmp/.X11-unix/X0 ] && break
    sleep 0.1
  done
fi

# Switch to VT7 (browser)
chvt 7 || true

# Wait for chromium to exit (managed by .xinitrc-browser's final exec)
# If chromiumctl daemonizes, replace this with a loop that waits on its PID/log.
wait
# Fall back to tty1 (ES)
chvt 1 || true

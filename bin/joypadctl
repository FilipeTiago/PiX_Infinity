#!/bin/bash
set -euo pipefail

PROFILE="${HOME}/padmouse.gamecontroller.amgp"
PATTERN="antimicrox.*${PROFILE}"

cmd="${1:-}"; shift || true

ensure_uinput() {
  # load uinput if missing; ignore if we lack perms
  [[ -e /dev/uinput ]] || sudo -n modprobe uinput 2>/dev/null || true
}

stop() {
  pkill -TERM -f "$PATTERN" 2>/dev/null || true
  for _ in {1..30}; do
    pgrep -f "$PATTERN" >/dev/null || break
    sleep 0.1
  done
  pgrep -f "$PATTERN" >/dev/null && pkill -KILL -f "$PATTERN" || true
  sleep 0.1
}

start() {
  ensure_uinput
  # donâ€™t double-spawn
  if pgrep -f "$PATTERN" >/dev/null; then
    echo "running"
    return 0
  fi
  nohup antimicrox --profile "${PROFILE}" --hidden >/dev/null 2>&1 &
  echo "started"
}

status() {
  pgrep -f "$PATTERN" >/dev/null && echo "running" || echo "stopped"
}

case "$cmd" in
  stop)    stop ;;
  start)   start ;;
  restart) stop; start ;;
  status)  status ;;
  *) echo "usage: joypadctl {start|stop|restart|status}"; exit 2 ;;
esac


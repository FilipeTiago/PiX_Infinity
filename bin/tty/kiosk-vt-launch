#!/usr/bin/env bash

# Try relative (repo/dev install), then fall back to canonical install path.
# shellcheck source=/dev/null
if ! source "$(dirname "${BASH_SOURCE[0]}")/system/paths" 2>/dev/null; then
  source "/opt/pix-infinity/bin/system/paths"
fi

set -euo pipefail
IFS=$'\n\t'
LOG_NAME="kiosk-vt-launch"; . /usr/local/bin/system/common.sh

usage() { echo "usage: $0 <VT#> <client ...>"; exit 2; }

(( $# >= 2 )) || usage
VT="$1"; shift
CLIENT=( "$@" )

init_dirs

# Who should the app run as?
RUN_AS="${SUDO_USER:-$USER}"
RUN_UID="$(id -u "$RUN_AS")"

# One X display number for these VT launches (your old default)
XNUM="${KIOSK_DISPLAY_BASE:-2}"

# Per-VT Xorg log
XLOG="$HOME/.local/share/xorg"; mkdir -p "$XLOG"
XLOG="$XLOG/Xorg-vt${VT}.log"

log "launch: VT=${VT} DISPLAY=:${XNUM} user=${RUN_AS}"
log "client: ${CLIENT[*]}"
echo "${CLIENT[*]}" > "/tmp/kiosk-vt${VT}-client.log" || true

# Make sure the user's runtime dir exists (PulseAudio, etc.)
if [[ ! -d "/run/user/${RUN_UID}" ]]; then
  mkdir -p "/run/user/${RUN_UID}"
  chown "${RUN_AS}:${RUN_AS}" "/run/user/${RUN_UID}"
fi

# Hop to the VT, start Xorg there, and run the client AS THE USER.
# xinit args: <client> -- <server-args...>
exec openvt -f -s -w -c "${VT}" -- \
  env XDG_VTNR="${VT}" XDG_RUNTIME_DIR="/run/user/${RUN_UID}" \
  xinit /sbin/runuser -u "${RUN_AS}" -- "${CLIENT[@]}" -- \
        ":${XNUM}" "vt${VT}" -keeptty -nolisten tcp >>"${XLOG}" 2>&1

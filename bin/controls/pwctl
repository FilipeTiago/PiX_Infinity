#!/usr/bin/env bash
# Music control script for PiX Infinity

set -euo pipefail
IFS=$'\n\t'
LOG_NAME="pwcctl"; . /usr/local/bin/system/common.sh

# Try relative (repo/dev install), then fall back to canonical install path.
# shellcheck source=/dev/null
if ! source "$(dirname "${BASH_SOURCE[0]}")/system/paths" 2>/dev/null; then
  source "/opt/pix-infinity/bin/system/paths"
fi

require_cmd pipewire

cmd="${1:-status}"

case "$cmd" in
  start|restart)
    systemctl --user daemon-reload
    systemctl --user enable --now pipewire wireplumber pipewire-pulse
    ;;
  stop)
    systemctl --user stop pipewire-pulse wireplumber pipewire
    ;;
  status)
    systemctl --user --no-pager --full status pipewire pipewire-pulse wireplumber
    ;;
  default-sink-hdmi)
    if command -v pactl >/dev/null; then
      HDMI=$(pactl list short sinks | awk '/hdmi|HDMI|alsa_output.*hdmi/ {print $2; exit}')
      [[ -n "$HDMI" ]] && pactl set-default-sink "$HDMI"
    fi
    ;;
  *) echo "usage: pwctl {start|stop|restart|status|default-sink-hdmi}"; exit 2 ;;
esac

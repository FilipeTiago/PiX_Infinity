#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'
LOG_NAME="screensaverctl"; . /usr/local/bin/system/common.sh

# Backend: chromium|mpv  (default chromium)
SCREENSAVER_BACKEND="${SCREENSAVER_BACKEND:-chromium}"
SCREENSAVER_URL="${SCREENSAVER_URL:-https://www.youtube.com/playlist?list=RDQM}"  # put your playlist here
SCREENSAVER_MUTE="${SCREENSAVER_MUTE:-1}"

LOCKNAME="kiosk-screensaver"

start_chromium() {
  require_cmd chromium-browser
  lock_or_exit "$LOCKNAME"

  pick_size; export W H
  local profile="$HOME/.config/chromium-saver"
  mkdir -p "$profile"; chmod 700 "$profile"
  # keep the profile clean between runs
  rm -f "$profile"/Singleton{Lock,Cookie,Socket,Deadlock} || true

  local args=(
    --class=KioskSaver --user-data-dir="$profile"
    --kiosk --start-fullscreen
    --no-sandbox --no-first-run --no-default-browser-check --test-type
    --disable-gpu --disable-gpu-compositing --in-process-gpu
    --use-gl=swiftshader --ozone-platform=x11 --ignore-gpu-blocklist
    --window-position=0,0 --window-size="${W},${H}"
    --disable-features=VaapiVideoDecodeAccelerator,VaapiVideoDecoder
  )
  [[ "$SCREENSAVER_MUTE" = "1" ]] && args+=(--mute-audio)

  log "exec chromium-browser (KioskSaver) ${W}x${H} url='${SCREENSAVER_URL}'"
  exec chromium-browser "${args[@]}" -- "$SCREENSAVER_URL"
}

start_mpv() {
  require_cmd mpv
  lock_or_exit "$LOCKNAME"
  audio_prepare
  pick_size; export W H

  local args=(
    --vo=gpu --gpu-context=x11
    --hwdec=auto-safe
    --fullscreen --no-border --cursor-autohide=yes
    --x11-name=KioskSaver --title=KioskSaver
    --geometry="${W}x${H}+0+0"
    --profile=sw-fast
  )
  [[ "$SCREENSAVER_MUTE" = "1" ]] && args+=(--mute=yes)
  log "exec mpv (KioskSaver) ${W}x${H} url='${SCREENSAVER_URL}'"
  exec mpv "${args[@]}" -- "$SCREENSAVER_URL"
}

stop() {
  # Kill either backend class
  local killed=0
  pkill -TERM -f 'chromium.*--class=KioskSaver' && killed=1 || true
  pkill -TERM -f 'mpv.*(--x11-name=KioskSaver|--title=KioskSaver)' && killed=1 || true
  [[ $killed -eq 0 ]] && { log "screensaver not running"; return 0; }

  for _ in {1..30}; do
    pgrep -f 'chromium.*--class=KioskSaver' >/dev/null && { sleep 0.2; continue; }
    pgrep -f 'mpv.*(--x11-name=KioskSaver|--title=KioskSaver)' >/dev/null && { sleep 0.2; continue; }
    break
  done
  pkill -KILL -f 'chromium.*--class=KioskSaver' || true
  pkill -KILL -f 'mpv.*(--x11-name=KioskSaver|--title=KioskSaver)' || true
}

status() {
  if pgrep -f 'chromium.*--class=KioskSaver' >/dev/null || \
     pgrep -f 'mpv.*(--x11-name=KioskSaver|--title=KioskSaver)' >/dev/null; then
    echo "running"
  else
    echo "stopped"
  fi
}

start() {
  case "$SCREENSAVER_BACKEND" in
    chromium) start_chromium ;;
    mpv)      start_mpv ;;
    *) die "unknown SCREENSAVER_BACKEND='$SCREENSAVER_BACKEND' (use chromium|mpv)" ;;
  esac
}

restart(){ stop; wait_for 1; start; }

case "${1:-}" in
  start|stop|status|restart) "$@";;
  *) echo "usage: ${0##*/} {start|stop|status|restart}
env: SCREENSAVER_BACKEND=chromium|mpv  SCREENSAVER_URL=<url>  SCREENSAVER_MUTE=1|0"; exit 2;;
esac

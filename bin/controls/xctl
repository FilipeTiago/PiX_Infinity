#!/usr/bin/env bash
# Xorg control script for PiX Infinity

set -euo pipefail
IFS=$'\n\t'
LOG_NAME="xctl"; . /usr/local/bin/system/common.sh

# Try relative (repo/dev install), then fall back to canonical install path.
# shellcheck source=/dev/null
if ! source "$(dirname "${BASH_SOURCE[0]}")/system/paths" 2>/dev/null; then
  source "/opt/pix-infinity/bin/system/paths"
fi

require_cmd Xorg

set -euo pipefail
cmd="${1:-}"; shift || true
VT="${XDG_VTNR:-1}"

start() {
  pgrep -x Xorg >/dev/null && { echo "running"; return; }
  xinit /usr/bin/true -- :0 vt${VT} -keeptty
}
stop() {
  pkill -TERM -x Xorg 2>/dev/null || true
  for _ in {1..30}; do pgrep -x Xorg >/dev/null || break; sleep 0.1; done
  pgrep -x Xorg >/dev/null && pkill -KILL -x Xorg || true
}
status() { pgrep -x Xorg >/dev/null && echo "running" || echo "stopped"; }

case "$cmd" in
  start) start ;;
  stop) stop  ;;
  restart) stop; start ;;
  status) status ;;
  *) echo "usage: xctl {start|stop|restart|status}"; exit 2 ;;
esac

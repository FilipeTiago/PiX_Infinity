#!/usr/bin/env bash
# Gallery control script

set -euo pipefail
IFS=$'\n\t'
LOG_NAME="galleryctl"; . /usr/local/bin/system/common.sh

# Try relative (repo/dev install), then fall back to canonical install path.
# shellcheck source=/dev/null
if ! source "$(dirname "${BASH_SOURCE[0]}")/system/paths" 2>/dev/null; then
  source "/opt/pix-infinity/bin/system/paths"
fi

# Prefer imv; fall back to feh
IMV="$(command -v imv || true)"
FEH="$(command -v feh || true)"
[[ -n "$IMV" || -n "$FEH" ]] || die "need imv or feh"

CLASS="${CLASS:-KioskGallery}"
LOCKNAME="kiosk-gallery"
# Patterns cover both imv and feh
PATTERN="(imv|feh).*(--class|--title).*${CLASS}"

start() {
  local path="${1:-.}"   # dir, file(s) or URL(s)
  lock_or_exit "$LOCKNAME"
  pick_size; export W H

  if [[ -n "$IMV" ]]; then
    # imv supports --class directly
    ARGS=( -f --class "$CLASS" --title "$CLASS" --start-centered --scale=down --recursive --slideshow 5 )
    log "exec imv slideshow '${path}'"
    exec "$IMV" "${ARGS[@]}" -- "$path"
  else
    # feh fallback; emulate class via --class and title via --title
    ARGS=( --fullscreen --hide-pointer --auto-zoom --slideshow-delay 5 --class "$CLASS" --title "$CLASS" )
    log "exec feh slideshow '${path}'"
    exec "$FEH" "${ARGS[@]}" -- "$path"
  fi
}

stop()   { pkill_pat "$PATTERN"; }
status() { if pgrep_pat "$PATTERN"; then echo "running"; else echo "stopped"; fi; }
restart(){ stop; wait_for 1; start "${1:-.}"; }

case "${1:-}" in
  start)   shift; start "$@";;
  stop)    stop;;
  status)  status;;
  restart) shift; restart "$@";;
  *) echo "usage: ${0##*/} {start|stop|status|restart} [DIR|FILE|URL]"; exit 2;;
esac

#!/usr/bin/env bash
set -euo pipefail

TARGET_USER="infinity"
XDISP=":0"
XAUTH="/home/${TARGET_USER}/.Xauthority"

# Choose OSK: prefer matchbox-keyboard; fall back to onboard
if command -v matchbox-keyboard >/dev/null 2>&1; then
  OSK_CMD="matchbox-keyboard"
  OSK_PGREP="matchbox-keyboard"   # use -f due to 15-char comm limit
elif command -v onboard >/dev/null 2>&1; then
  OSK_CMD="env GSETTINGS_BACKEND=dconf onboard"
  OSK_PGREP="onboard"
else
  logger "osk-toggle: no on-screen keyboard installed"
  exit 1
fi

# Run under the desktop user so X allows the window
runuser -u "${TARGET_USER}" -- bash -lc '
  set -euo pipefail
  export DISPLAY='"${XDISP}"'
  export XAUTHORITY='"${XAUTH}"'

  # If OSK is running, kill it; else start it
  if pgrep -f -u "${USER}" "'"${OSK_PGREP}"'" >/dev/null 2>&1; then
    pkill -f -u "${USER}" "'"${OSK_PGREP}"'"
  else
    nohup '"${OSK_CMD}"' >/dev/null 2>&1 &
  fi
'

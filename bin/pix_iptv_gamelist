#!/usr/bin/env bash
# Build a gamelist.xml for the IPTV system using per-channel .m3u files and logos.
# - ROM root discovered via `pix_rom_location iptv`
# - Logos expected under ~/.emulationstation/downloaded_images/iptv/logos/<CC>/<genre>/<channel>.* (from pix_iptv_index)
set -euo pipefail

need(){ command -v "$1" >/dev/null 2>&1 || { echo "[iptv-gamelist] missing: $1" >&2; exit 2; }; }
need pix_rom_location

ROM_ROOT="$(pix_rom_location iptv || true)"
[[ -n "${ROM_ROOT:-}" ]] || { echo "[iptv-gamelist] iptv ROM root not found"; exit 1; }
[[ -d "$ROM_ROOT" ]] || { echo "[iptv-gamelist] ROM root not a directory: $ROM_ROOT"; exit 1; }

GAMELIST="$ROM_ROOT/gamelist.xml"
LOGOS="$HOME/.emulationstation/downloaded_images/iptv/logos"

xml_escape(){ sed -e 's/&/\&amp;/g' -e 's/</\&lt;/g' -e 's/>/\&gt;/g' -e 's/\"/\&quot;/g' -e "s/'/\&apos;/g"; }

echo "[iptv-gamelist] ROM root: $ROM_ROOT"
TMP="$(mktemp)"; trap 'rm -f "$TMP"' EXIT

{
  echo '<?xml version="1.0"?>'
  echo '<gameList>'
} > "$TMP"

count=0
# find every .m3u under the iptv folder
while IFS= read -r -d '' f; do
  rel="${f#$ROM_ROOT/}"
  base="$(basename "$f")"
  name="${base%.m3u}"
  # prettify name a little
  disp="$(printf '%s' "$name" | sed 's/_/ /g; s/  \+/ /g')"

  cc="$(basename "$(dirname "$(dirname "$rel")")")"
  genre="$(basename "$(dirname "$rel")")"

  # locate any logo extension that exists
  logo=""
  for ext in png jpg jpeg webp gif; do
    cand="$LOGOS/$cc/$genre/$name.$ext"
    [[ -f "$cand" ]] && { logo="$cand"; break; }
  done

  # write entry (paths relative to ROM root)
  {
    echo '  <game>'
    echo "    <path>./$(printf '%s' "$rel" | xml_escape)</path>"
    echo "    <name>$(printf '%s' "$disp" | xml_escape)</name>"
    [[ -n "$logo" ]] && echo "    <image>$(printf '%s' "$logo" | xml_escape)</image>"
    echo "    <desc>Country: $cc Â· Genre: $genre</desc>"
    echo '  </game>'
  } >> "$TMP"

  count=$((count+1))
done < <(find "$ROM_ROOT" -type f -name '*.m3u' -print0 | sort -z)

echo '</gameList>' >> "$TMP"
mv "$TMP" "$GAMELIST"
chmod 644 "$GAMELIST"

echo "[iptv-gamelist] wrote $GAMELIST  (items: $count)"

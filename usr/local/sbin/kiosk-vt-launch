#!/bin/bash
set -euo pipefail
# Usage: kiosk-vt-launch <VT> <client...>

VT="${1:?need VT number}"; shift
CLIENT=("$@")

# map VT→display number (vt8→:2, vt9→:3, …)
case "$VT" in
  8) XNUM=2 ;;
  9) XNUM=3 ;;
  10) XNUM=4 ;;
  11) XNUM=5 ;;
  12) XNUM=6 ;;
  13) XNUM=7 ;;
  *) XNUM=2 ;;
esac

RUN_AS="${SUDO_USER:-$(logname 2>/dev/null || echo infinity)}"
RUN_UID="$(id -u "$RUN_AS")"
HOME_DIR="$(getent passwd "$RUN_AS" | cut -d: -f6)"

XLOG="${HOME_DIR}/.local/share/xorg/Xorg-vt${VT}.log"
CLOG="/tmp/kiosk-vt${VT}-client.log"
mkdir -p "${HOME_DIR}/.local/share/xorg"

{
  echo "[$(date +%T)] launch: VT=${VT} DISPLAY=:${XNUM} user=${RUN_AS}"
  echo "[$(date +%T)] client: ${CLIENT[*]}"
  echo "[$(date +%T)] XLOG:   ${XLOG}"
} | tee -a /tmp/kiosk-vt-launch.log

# don’t leak an SSH DISPLAY to xinit
unset DISPLAY

# Switch to the VT as root, but run X **client** as $RUN_AS
exec /usr/bin/openvt -f -s -w -c "$VT" -- \
  /usr/bin/xinit /bin/sh -c '
      # xinit sets DISPLAY. Drop to target user for the client.
      export XDG_RUNTIME_DIR="/run/user/'"$RUN_UID"'"
      export HOME="'"$HOME_DIR"'"
      xset s off -dpms >/dev/null 2>&1 || true
      xsetroot -solid black >/dev/null 2>&1 || true
      exec /sbin/runuser -u "'"$RUN_AS"'" -- "$@"
  ' sh "${CLIENT[@]}" \
  -- ":${XNUM}" "vt${VT}" -keeptty \
  >"$CLOG" 2>&1

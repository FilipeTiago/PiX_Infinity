#!/bin/sh
set -u

# Basic screen/keyboard niceties
xset -dpms >/dev/null 2>&1 || true
xset s off  >/dev/null 2>&1 || true
setxkbmap -layout pt >/dev/null 2>&1 || true

# Drop-priv info from kiosk-vt-launch
RUN_AS="${KIOSK_RUN_AS:-}"
RUN_HOME="${KIOSK_HOME:-}"
RUN_RUNTIME="${KIOSK_XDG_RUNTIME:-}"

# Helper to run a command as the kiosk user with correct HOME/RUNTIME
as_user() {
  if [ -n "$RUN_AS" ]; then
    sudo -u "$RUN_AS" -H env HOME="${RUN_HOME:-/home/$RUN_AS}" \
      XDG_RUNTIME_DIR="${RUN_RUNTIME:-/run/user/$(id -u "$RUN_AS")}" "$@"
  else
    "$@"
  fi
}

# Start a minimal WM (as user) so focus/keys behave
if command -v openbox >/dev/null 2>&1; then
  as_user openbox >/dev/null 2>&1 &
elif command -v matchbox-window-manager >/dev/null 2>&1; then
  as_user matchbox-window-manager -use_titlebar no >/dev/null 2>&1 &
elif command -v fluxbox >/dev/null 2>&1; then
  as_user fluxbox >/dev/null 2>&1 &
else
  as_user twm >/dev/null 2>&1 &
fi

# Optional hotkeys (Alt+F12 â†’ kiosk-quit, etc.)
command -v sxhkd >/dev/null 2>&1 && as_user sxhkd >/dev/null 2>&1 &

# Optional: try to raise the window by class
if command -v wmctrl >/dev/null 2>&1; then
  CLASS="${KIOSK_WM_FOCUS_CLASS:-KioskChromium}"
  (
    for i in $(seq 1 80); do
      wmctrl -x -a "$CLASS" 2>/dev/null && exit 0
      sleep 0.25
    done
  ) &
fi

# Finally run the client as the kiosk user
exec as_user "$@"
